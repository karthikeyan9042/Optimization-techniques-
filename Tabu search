import pandas as pd
import random as rd
from itertools import combinations

class TS:
    def __init__(self, seed, tabu_tenure):
        self.seed = seed
        self.tabu_tenure = tabu_tenure
        self.instance_dict = self.input_data()
        self.Initial_solution = self.get_InitialSolution()
        self.tabu_str, self.Best_solution, self.Best_objvalue = self.TSearch()

    def input_data(self):
        # Hardcoded job data: Job ID â†’ weight, processing_time, due_date
        return {
            1: {'weight': 4, 'processing_time': 3, 'due_date': 5},
            2: {'weight': 2, 'processing_time': 2, 'due_date': 4},
            3: {'weight': 3, 'processing_time': 1, 'due_date': 6},
            4: {'weight': 5, 'processing_time': 4, 'due_date': 7},
            5: {'weight': 1, 'processing_time': 2, 'due_date': 3}
        }

    def get_tabuestructure(self):
        tabu_dict = {}
        for swap in combinations(self.instance_dict.keys(), 2):
            tabu_dict[swap] = {'tabu_time': 0, 'MoveValue': 0}
        return tabu_dict

    def get_InitialSolution(self):
        n_jobs = len(self.instance_dict)
        initial_solution = list(self.instance_dict.keys())
        rd.seed(self.seed)
        rd.shuffle(initial_solution)
        return initial_solution

    def Objfun(self, solution):
        data = self.instance_dict
        t = 0
        objfun_value = 0
        for job in solution:
            C_i = t + data[job]["processing_time"]
            d_i = data[job]["due_date"]
            T_i = max(0, C_i - d_i)
            W_i = data[job]["weight"]
            objfun_value += W_i * T_i
            t = C_i
        return objfun_value

    def SwapMove(self, solution, i, j):
        solution = solution.copy()
        i_index = solution.index(i)
        j_index = solution.index(j)
        solution[i_index], solution[j_index] = solution[j_index], solution[i_index]
        return solution

    def TSearch(self):
        tenure = self.tabu_tenure
        tabu_structure = self.get_tabuestructure()
        best_solution = self.Initial_solution
        best_objvalue = self.Objfun(best_solution)
        current_solution = self.Initial_solution
        current_objvalue = self.Objfun(current_solution)
        iter = 1
        Terminate = 0

        while Terminate < 100:
            if iter <= 10:
                print(f"Iteration {iter}: Best_objvalue: {best_objvalue}")

            for move in tabu_structure:
                candidate_solution = self.SwapMove(current_solution, move[0], move[1])
                candidate_objvalue = self.Objfun(candidate_solution)
                tabu_structure[move]['MoveValue'] = candidate_objvalue

            while True:
                best_move = min(tabu_structure, key=lambda x: tabu_structure[x]['MoveValue'])
                MoveValue = tabu_structure[best_move]['MoveValue']
                tabu_time = tabu_structure[best_move]['tabu_time']

                if tabu_time < iter:
                    current_solution = self.SwapMove(current_solution, best_move[0], best_move[1])
                    current_objvalue = self.Objfun(current_solution)

                    if MoveValue < best_objvalue:
                        best_solution = current_solution
                        best_objvalue = current_objvalue
                        Terminate = 0
                    else:
                        Terminate += 1

                    tabu_structure[best_move]['tabu_time'] = iter + tenure
                    iter += 1
                    break

                else:
                    if MoveValue < best_objvalue:
                        current_solution = self.SwapMove(current_solution, best_move[0], best_move[1])
                        current_objvalue = self.Objfun(current_solution)
                        best_solution = current_solution
                        best_objvalue = current_objvalue
                        Terminate = 0
                        iter += 1
                        break
                    else:
                        tabu_structure[best_move]["MoveValue"] = float('inf')
                        continue

        print("\nTabu search completed")
        print("\nPerformed iterations:", iter)
        print("Best found Solution:", best_solution)
        print("Best Objective Value:", best_objvalue)
        return tabu_structure, best_solution, best_objvalue


# --- MAIN EXECUTION ---
if __name__ == "__main__":
    print("Starting Tabu Search...\n")
    test = TS(seed=2012, tabu_tenure=3)
    print("\nTabu Search Completed.")
    print("Best Solution:", test.Best_solution)
    print("Best Objective Value:", test.Best_objvalue)
